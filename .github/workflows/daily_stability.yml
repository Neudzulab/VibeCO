name: daily-stability
on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch: {}

jobs:
  daily:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    env:
      PROD_BASE_URL: ${{ secrets.PROD_BASE_URL }}
      PROD_API_TOKEN: ${{ secrets.PROD_API_TOKEN }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements.txt
      - name: Run daily stabilization suite
        run: python scripts/daily/run_all.py
      - name: Commit daily report
        run: |
          d=$(date -u +"%Y-%m-%d")
          git config user.name "prod-bot"
          git config user.email "bot@users.noreply.github.com"
          git add reports/daily/$d.md artifacts/*.json || true
          git commit -m "chore(prod): daily report $d" || echo "no changes"
          git push || true
      - name: Open issues on breach
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'PY'
          import datetime
          import json
          import os
          import subprocess
          from pathlib import Path

          today = datetime.datetime.utcnow().date().isoformat()
          slo = json.loads(Path("artifacts/slo.json").read_text())
          logs = json.loads(Path("artifacts/logs.json").read_text())
          if (not slo.get("slo_ok")) or logs.get("count", 0) > 0:
              title = "[Stability] Günlük bulgular ve/veya SLO ihlali"
              body = f"Rapor: reports/daily/{today}.md"
              env = dict(os.environ)
              token = env.get("GITHUB_TOKEN")
              if token:
                  env["GH_TOKEN"] = token
              try:
                  subprocess.check_call([
                      "gh",
                      "issue",
                      "create",
                      "-t",
                      title,
                      "-b",
                      body,
                      "-l",
                      "stability,prod",
                  ], env=env)
              except Exception as exc:
                  print(f"gh issue create failed: {exc}")
          PY
